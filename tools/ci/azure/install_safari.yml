parameters:
  channel: preview

# Should match https://web-platform-tests.org/running-tests/safari.html
steps:
- ${{ if eq(parameters.channel, 'preview') }}:
  - script: sudo /usr/bin/dscl . -passwd /Users/vsts vsts
  - script: sudo rm -r /Users/vsts/Library/Keychains/*
  - script: |
      # Pinned to Safari Technology Preview version 91.
      HOMEBREW_NO_AUTO_UPDATE=1 brew cask install https://raw.githubusercontent.com/Homebrew/homebrew-cask-versions/d42a0fa4b46a0404350a306a4811f69a66b70873/Casks/safari-technology-preview.rb
      expect tools/ci/azure/enable_safaridriver_preview.exp
      defaults write com.apple.SafariTechnologyPreview WebKitJavaScriptCanOpenWindowsAutomatically 1
      defaults write com.apple.SafariTechnologyPreview ExperimentalServerTimingEnabled 1
    displayName: 'Install Safari Technology Preview'
- ${{ if eq(parameters.channel, 'stable') }}:
  - script: |
      sudo safaridriver --enable
      defaults write com.apple.Safari WebKitJavaScriptCanOpenWindowsAutomatically 1
    displayName: 'Configure Safari'
